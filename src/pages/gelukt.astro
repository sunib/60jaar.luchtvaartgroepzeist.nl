---
import Hero from '~/components/widgets/Hero.astro';
import Layout from '~/layouts/PageLayout.astro';
import imageWedstrijd from '~/assets/images/wedstrijd2.jpg';
import Header from '~/components/widgets/Header.astro';
import Contact from '~/components/widgets/Contact.astro';

const title = `Gelukt`;
const mail = '<a data-obfuscation href="mailto:60jaar@luchtvaartgroepzeist.nl">60jaar@luchtvaartgroepzeist.nl</a>';
---

<Layout metadata={{ title }}>
  <Fragment slot="announcement"></Fragment>
  <Fragment slot="header">
    <Header
      links={[
        { text: 'Home', href: '/' },
        {
          text: 'Activiteiten',
          links: [
            {
              text: 'Dodenherdenking Werkhoven',
              href: '/#dodenherdenking',
            },
            {
              text: 'Modelvliegwedstrijden XL',
              href: '/#vliegwedstrijd',
            },
            {
              text: 'Sanicole Airshow',
              href: '/#vliegshow',
            },
            {
              text: 'Reunie',
              href: '/#reunie',
            },
          ],
        },
        {
          text: 'FAQ',
          href: '/#faq',
        },
        {
          text: 'Contact',
          href: '/#contact',
        },
      ]}
      actions={[
        {
          text: 'Schrijf je in! âœï¸',
          href: '/#inschrijven',
        },
      ]}
      isSticky
      showToggleTheme
    />
  </Fragment>

  <Hero
    tagline="Dank voor het inschrijven!"
    image={{
      src: imageWedstrijd,
      alt: 'Caos Image',
    }}
  >
    <Fragment slot="title">
      Nu helpen we je te <br />
      <span class="text-accent dark:text-white highlight"> betalen!</span>
    </Fragment>

    <Fragment slot="subtitle">
      <!-- Betaling sectie -->
      <div class="py-16 md:py-20" id="payment-section">
        <div class="mx-auto max-w-3xl px-4 sm:px-6">
          <div id="payment-container" class="hidden">
            <div class="mb-8 text-center">
              <h2 class="text-3xl font-bold tracking-tight dark:text-white sm:text-4xl mb-4">ðŸ’³ Betaling BBQ</h2>
              <p class="text-lg text-gray-600 dark:text-gray-400">
                Hieronder kun je direct betalen voor je BBQ deelname via iDEAL of bankoverschrijving
              </p>
            </div>

            <div
              class="flex flex-col max-w-xl mx-auto rounded-lg backdrop-blur border border-gray-200 dark:border-gray-700 bg-slate-100 dark:bg-slate-900 shadow p-6 w-full"
            >
              <div id="payment-details" class="space-y-4">
                <!-- Wordt gevuld door JavaScript -->
              </div>
            </div>
          </div>

          <div id="no-payment-message" class="text-center text-gray-600 dark:text-gray-400">
            <p>
              Geen betalingsgegevens gevonden. Mogelijk heb je geen BBQ deelname opgegeven of zijn de gegevens verlopen.
            </p>
          </div>
        </div>
      </div>

      Je krijg nu automatisch een e-maill met daarin een bevestiging van je inschrijving. Als je jezelf later afvraagt
      wat je had opgegeven, dat staat er ook in. <br /><br />
    </Fragment>
  </Hero>

  <Contact mail={mail} />
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const paymentContainer = document.getElementById('payment-container');
    const paymentDetails = document.getElementById('payment-details');
    const noPaymentMessage = document.getElementById('no-payment-message');

    // Haal betaalgegevens uit localStorage
    console.log("Retrieving BBQ payment data...");
    const paymentDataStr = localStorage.getItem('bbq-payment');

    if (paymentDataStr) {
      console.log("Yes found something");
      try {
        const paymentData = JSON.parse(paymentDataStr);
        const { total, adults, children, timestamp } = paymentData;

        // Check of de gegevens niet te oud zijn (bijv. 24 uur)
        const now = new Date();
        const paymentTime = new Date(timestamp);
        const hoursDiff = (now.getTime() - paymentTime.getTime()) / (1000 * 3600);

        if (hoursDiff > 24) {
          // Gegevens zijn te oud, toon geen betaling
          localStorage.removeItem('bbq-payment');
          console.log("Data to old removing");
          return;
        }

        if (total > 0) {
          // Toon betaling sectie
          paymentContainer?.classList.remove('hidden');
          noPaymentMessage?.classList.add('hidden');

          const ingUrl =
            'https://www.ing.nl/de-ing/payreq?trxid=SrtprGS3xyaM0E09FfnQR0mfQ9eF4brf&flow-step=payment-request';

          if (paymentDetails) {
            paymentDetails.innerHTML = `
              <div class="space-y-4">
                <div class="text-center">
                  <div class="text-sm text-gray-700 dark:text-gray-300 mb-2">
                    <div class="flex justify-between mb-1">
                      <span>Volwassenen (${adults}x â‚¬25.00):</span>
                      <span>â‚¬${(adults * 25).toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between mb-2">
                      <span>Kinderen (${children}x â‚¬12.50):</span>
                      <span>â‚¬${(children * 12.5).toFixed(2)}</span>
                    </div>
                    <hr class="my-2 border-gray-300 dark:border-gray-600">
                    <div class="flex justify-between font-bold text-lg">
                      <span>Totaalbedrag:</span>
                      <span class="text-blue-600 dark:text-blue-400">â‚¬${total.toFixed(2)}</span>
                    </div>
                  </div>
                </div>
                
                <div class="text-sm text-gray-600 dark:text-gray-400 text-center mb-4">
                  Let op: je vult ZELF het totaal bedrag (â‚¬${total.toFixed(2)}) in bij de iDEAL betaling! 
                </div>
                
                <div class="space-y-3">
                  <a href="${ingUrl}" target="_blank" id="payment-button"
                     class="w-full inline-flex justify-center items-center px-4 py-3 bg-orange-600 hover:bg-orange-700 text-white font-medium rounded-lg transition-colors">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                    Betaal â‚¬${total.toFixed(2)} via iDEAL
                  </a>
                  
                  <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded p-3">
                    <div class="text-sm text-blue-700 dark:text-blue-300">
                      <div class="font-medium mb-1">ðŸ’¡ Alternatief: Bankoverschrijving</div>
                      <div class="space-y-1 text-xs">
                        <div><strong>IBAN:</strong> NL92 INGB 0002 0715 45</div>
                        <div><strong>Ten name van:</strong> Scouting Luchtvaartgroep Zeist</div>
                        <div><strong>Bedrag:</strong> â‚¬${total.toFixed(2)}</div>
                        <div><strong>Omschrijving:</strong> Reunie Luchtvaartgroep Zeist + je naam</div>
                      </div>
                    </div>
                  </div>
                  
                  <button type="button" id="mark-paid-button"
                          class="w-full inline-flex justify-center items-center px-3 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    âœ… Ik heb zojuist betaald
                  </button>
                </div>
              </div>
            `;

            // Event listener voor "Ik heb betaald" knop
            const markPaidButton = document.getElementById('mark-paid-button');
            markPaidButton?.addEventListener('click', function () {
              // Verwijder betaalgegevens uit localStorage
              localStorage.removeItem('bbq-payment');

              // Verberg betaling sectie
              paymentContainer?.classList.add('hidden');

              // Toon bevestiging
              const confirmation = document.createElement('div');
              confirmation.className =
                'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
              confirmation.innerHTML = 'âœ… Bedankt! Je betaling is genoteerd.';
              document.body.appendChild(confirmation);

              // Verwijder bevestiging na 4 seconden
              setTimeout(() => {
                if (document.body.contains(confirmation)) {
                  document.body.removeChild(confirmation);
                }
              }, 4000);
            });
          }
        }
      } catch (error) {
        console.error('Error parsing payment data:', error);
        localStorage.removeItem('bbq-payment');
      }
    }
  });
</script>
